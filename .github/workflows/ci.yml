# =============================================================================
# CI Pipeline - Pull Request Validation
#
# Runs on every pull request to validate:
# - SQL linting with SQLFluff
# - YAML validation
# - dbt compile and parse
# - dbt tests with test database
# - Docker build validation
#
# Author: Data Engineering Team
# =============================================================================

name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Linting and Validation
  # ===========================================================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff yamllint

      - name: Lint SQL with SQLFluff
        run: |
          sqlfluff lint dbt/spotify_dq/models --dialect postgres || true
        continue-on-error: true

      - name: Validate YAML files
        run: |
          yamllint -d relaxed dbt/spotify_dq/*.yml || true
          yamllint -d relaxed dbt/spotify_dq/models/**/*.yml || true
        continue-on-error: true

  # ===========================================================================
  # dbt Validation
  # ===========================================================================
  dbt-validate:
    name: dbt Compile & Parse
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: spotify
          POSTGRES_PASSWORD: spotify_password
          POSTGRES_DB: spotify_warehouse
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Create dbt profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          spotify_dq:
            target: ci
            outputs:
              ci:
                type: postgres
                host: localhost
                port: 5432
                user: spotify
                password: spotify_password
                dbname: spotify_warehouse
                schema: public
                threads: 4
          EOF
          sed -i 's/^          //' ~/.dbt/profiles.yml
          cat ~/.dbt/profiles.yml

      - name: Initialize PostgreSQL schemas
        run: |
          PGPASSWORD=spotify_password psql -h localhost -U spotify -d spotify_warehouse << 'EOF'
          CREATE SCHEMA IF NOT EXISTS raw;
          CREATE SCHEMA IF NOT EXISTS staging;
          CREATE SCHEMA IF NOT EXISTS intermediate;
          CREATE SCHEMA IF NOT EXISTS marts;
          CREATE SCHEMA IF NOT EXISTS analytics;
          CREATE SCHEMA IF NOT EXISTS data_quality;
          CREATE SCHEMA IF NOT EXISTS seeds;
          EOF

      - name: dbt deps (installs dbt-utils, dbt-expectations)
        run: |
          cd dbt/spotify_dq
          dbt deps

      - name: dbt parse
        run: |
          cd dbt/spotify_dq
          dbt parse

      - name: dbt compile
        run: |
          cd dbt/spotify_dq
          dbt compile

  # ===========================================================================
  # dbt Tests
  # ===========================================================================
  dbt-test:
    name: dbt Test Suite
    runs-on: ubuntu-latest
    needs: dbt-validate

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: spotify
          POSTGRES_PASSWORD: spotify_password
          POSTGRES_DB: spotify_warehouse
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Create dbt profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          spotify_dq:
            target: ci
            outputs:
              ci:
                type: postgres
                host: localhost
                port: 5432
                user: spotify
                password: spotify_password
                dbname: spotify_warehouse
                schema: public
                threads: 4
          EOF
          sed -i 's/^          //' ~/.dbt/profiles.yml
          cat ~/.dbt/profiles.yml

      - name: Initialize PostgreSQL schemas
        run: |
          PGPASSWORD=spotify_password psql -h localhost -U spotify -d spotify_warehouse << 'EOF'
          CREATE SCHEMA IF NOT EXISTS raw;
          CREATE SCHEMA IF NOT EXISTS staging;
          CREATE SCHEMA IF NOT EXISTS intermediate;
          CREATE SCHEMA IF NOT EXISTS marts;
          CREATE SCHEMA IF NOT EXISTS analytics;
          CREATE SCHEMA IF NOT EXISTS data_quality;
          CREATE SCHEMA IF NOT EXISTS seeds;

          -- Create raw table for testing (column names match source definition)
          CREATE TABLE IF NOT EXISTS raw.spotify_tracks_raw (
            track_name TEXT,
            artist_name TEXT,
            album_name TEXT,
            genre TEXT,
            release_date TEXT,
            tempo NUMERIC,
            loudness NUMERIC,
            energy NUMERIC,
            danceability NUMERIC,
            instrumentalness NUMERIC,
            popularity NUMERIC,
            stream_count BIGINT,
            country TEXT,
            label TEXT,
            _loaded_at TIMESTAMP DEFAULT NOW(),
            _source_file TEXT
          );

          -- Insert sample data for tests
          INSERT INTO raw.spotify_tracks_raw
          (track_name, artist_name, album_name, genre, release_date,
           tempo, loudness, energy, danceability, instrumentalness,
           popularity, stream_count, country, label)
          VALUES
          ('Test Track 1', 'Artist A', 'Album X', 'Pop', '2023-01-15',
           120.5, -5.2, 0.8, 0.75, 0.01, 85, 1000000, 'US', 'Sony'),
          ('Test Track 2', 'Artist B', 'Album Y', 'Rock', '2022-06-20',
           140.2, -6.8, 0.9, 0.60, 0.05, 72, 500000, 'UK', 'Universal');
          EOF

      - name: dbt deps
        run: |
          cd dbt/spotify_dq
          dbt deps

      - name: dbt seed
        run: |
          cd dbt/spotify_dq
          dbt seed

      - name: dbt run
        run: |
          cd dbt/spotify_dq
          dbt run --full-refresh

      - name: dbt test
        run: |
          cd dbt/spotify_dq
          dbt test --store-failures
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dbt-test-results
          path: dbt/spotify_dq/target/

  # ===========================================================================
  # Docker Build Validation
  # ===========================================================================
  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Airflow image
        uses: docker/build-push-action@v5
        with:
          context: ./airflow
          push: false
          tags: spotify-airflow:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Validate docker-compose
        run: |
          cd docker
          docker compose config --quiet
